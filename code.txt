
import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.preprocessing import StandardScaler, LabelEncoder
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
from sklearn.cluster import KMeans

st.title("Morning Routine Productivity Analysis")

uploaded = st.file_uploader("Upload Morning_Routine_Productivity_Dataset.csv", type=["csv"])

if uploaded:
    df = pd.read_csv(uploaded)
    st.subheader("Dataset Preview")
    st.dataframe(df.head())

    # Numerical description
    st.subheader("Statistics")
    st.write(df.describe())

    # Countplot
    st.subheader("Distribusi Skor Produktivitas")
    fig, ax = plt.subplots()
    sns.countplot(x="Productivity_Score (1-10)", data=df, ax=ax)
    st.pyplot(fig)

    # Sleep histogram
    st.subheader("Distribusi Durasi Tidur")
    fig, ax = plt.subplots()
    sns.histplot(df["Sleep Duration (hrs)"], bins=20, kde=True, ax=ax)
    st.pyplot(fig)

    # Heatmap correlation
    st.subheader("Heatmap Korelasi")
    numeric_df = df.select_dtypes(include=np.number)
    fig, ax = plt.subplots(figsize=(10, 6))
    sns.heatmap(numeric_df.corr(), annot=True, cmap="coolwarm", ax=ax)
    st.pyplot(fig)

    # Feature engineering
    df_fe = df.copy()
    for col in df_fe.select_dtypes(include="object").columns:
        df_fe[col] = LabelEncoder().fit_transform(df_fe[col])

    df_fe["Produktif"] = (df_fe["Productivity_Score (1-10)"] >= 7).astype(int)

    # Regression model
    st.subheader("Regression Model")
    X = df_fe.drop(columns=["Productivity_Score (1-10)", "Produktif"])
    y = df_fe["Productivity_Score (1-10)"]

    X_train, X_temp, y_train, y_temp = train_test_split(X, y, test_size=0.2, random_state=42)
    X_val, X_test, y_val, y_test = train_test_split(X_temp, y_temp, test_size=0.5, random_state=42)

    lin = LinearRegression().fit(X_train, y_train)
    rf = RandomForestRegressor(n_estimators=100, random_state=42).fit(X_train, y_train)

    mse_lin = mean_squared_error(y_val, lin.predict(X_val))
    mse_rf = mean_squared_error(y_val, rf.predict(X_val))

    st.write("MSE Linear Regression:", mse_lin)
    st.write("MSE Random Forest:", mse_rf)

    # Clustering
    st.subheader("KMeans Clustering")
    X_unsup = df_fe.drop(columns=["Productivity_Score (1-10)", "Produktif"])
    X_scaled = StandardScaler().fit_transform(X_unsup)
    kmeans = KMeans(n_clusters=3, random_state=42, n_init=10)
    df_fe["Cluster"] = kmeans.fit_predict(X_scaled)

    fig, ax = plt.subplots()
    sns.scatterplot(
        x=df["Sleep Duration (hrs)"],
        y=df["Productivity_Score (1-10)"],
        hue=df_fe["Cluster"],
        palette="Set2",
        ax=ax)
    st.pyplot(fig)

else:
    st.info("Upload dataset CSV untuk memulai.")
